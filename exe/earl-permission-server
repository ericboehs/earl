#!/usr/bin/env ruby
# frozen_string_literal: true

$stdout.sync = true
$stderr.sync = true

begin
  require "bundler/setup"
rescue LoadError
  # Running as installed gem without Bundler
end
require_relative "../lib/earl"

Earl.logger.level = Logger::WARN

config = Earl::Mcp::Config.new
api_config = config.to_api_config
api_client = Earl::Mattermost::ApiClient.new(api_config)

store = Earl::Memory::Store.new
approval_handler = Earl::Mcp::ApprovalHandler.new(config: config, api_client: api_client)
memory_handler = Earl::Mcp::MemoryHandler.new(
  store: store, username: ENV.fetch("EARL_CURRENT_USERNAME", nil)
)
heartbeat_handler = Earl::Mcp::HeartbeatHandler.new(
  default_channel_id: ENV.fetch("PLATFORM_CHANNEL_ID", nil)
)
tmux_store = Earl::TmuxSessionStore.new
tmux_handler = Earl::Mcp::TmuxHandler.new(
  config: config, api_client: api_client, tmux_store: tmux_store
)
pearl_handler = Earl::Mcp::PearlHandler.new(
  config: config, api_client: api_client, tmux_store: tmux_store
)
github_pat_handler = Earl::Mcp::GithubPatHandler.new(
  config: config, api_client: api_client
)

server = Earl::Mcp::Server.new(handlers: [approval_handler, memory_handler, heartbeat_handler, tmux_handler,
                                          pearl_handler, github_pat_handler])

server.run
