#!/usr/bin/env ruby
# frozen_string_literal: true

$stdout.sync = true
$stderr.sync = true

original_verbose = $VERBOSE
$VERBOSE = nil
begin
  require "bundler/setup"
rescue LoadError
  # Running as installed gem without Bundler — dependencies resolved by RubyGems
end
$VERBOSE = original_verbose
require_relative "../lib/earl"

pid_file = File.join(Earl.config_root, "earl.pid")

case ARGV[0]
when "heartbeat", "thread"
  require_relative "../lib/earl/cli"
  Earl::Cli.run(ARGV)
  exit 0
when "home"
  puts Earl.claude_home
  exit 0
when "exec"
  dir = Earl.claude_home
  cmd = ARGV.drop(1)
  if cmd.empty?
    puts dir
    exit 0
  end
  unless Dir.exist?(dir)
    warn "Claude home directory not found: #{dir}"
    warn "Run 'earl-install' to set up, or set EARL_CLAUDE_HOME"
    exit 1
  end
  Dir.chdir(dir)
  begin
    Kernel.exec(*cmd)
  rescue Errno::ENOENT
    warn "Command not found: #{cmd.first}"
    exit 127
  rescue Errno::EACCES
    warn "Permission denied: #{cmd.first}"
    exit 126
  end
when "restart"
  unless File.exist?(pid_file)
    warn "No PID file found at #{pid_file} — is EARL running?"
    exit 1
  end

  pid = File.read(pid_file).strip.to_i
  begin
    Process.kill("HUP", pid)
    puts "Sent SIGHUP to EARL (pid #{pid})"
  rescue Errno::ESRCH
    warn "Process #{pid} not found — removing stale PID file"
    File.delete(pid_file)
    exit 1
  end
  exit 0
when "update"
  repo_dir = File.expand_path("..", __dir__)
  Dir.chdir(repo_dir) do
    system("git", "pull", "--ff-only") || warn("git pull failed")
    system({ "RUBYOPT" => "-W0" }, "bundle", "install", "--quiet") || warn("bundle install failed")
  end
  puts "Updated. Run 'earl restart' to apply."
  exit 0
end

Earl.logger.level = ENV["EARL_DEBUG"] ? Logger::DEBUG : Logger::INFO
Earl.logger.info "Starting EARL..."
File.write(pid_file, Process.pid.to_s)
runner = Earl::Runner.new
at_exit { FileUtils.rm_f(pid_file) }
runner.start
