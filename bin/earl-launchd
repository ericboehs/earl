#!/usr/bin/env bash
set -euo pipefail

EARL_DIR="$(cd "$(dirname "$0")/.." && pwd)"

# launchd provides a minimal PATH; use mise shims so the active Ruby version is resolved dynamically
export PATH="$HOME/.local/share/mise/shims:$HOME/.local/bin:/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin"
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"

# Load EARL environment variables (required for Mattermost credentials)
ENV_FILE="$HOME/.config/earl/env"
if [ ! -f "$ENV_FILE" ]; then
  echo "FATAL: Environment file not found: $ENV_FILE" >&2
  echo "  Run 'bin/earl-install' to create it, then fill in your secrets." >&2
  exit 1
fi
set -a
# shellcheck source=/dev/null
source "$ENV_FILE"
set +a

# Ensure EARL project dir exists (used as default working dir for Claude subprocesses)
EARL_PROJECT_DIR="${EARL_CLAUDE_HOME:-$HOME/.config/earl/claude-home}"
mkdir -p "$EARL_PROJECT_DIR"

cd "$EARL_DIR"
exec bundle exec ruby bin/earl
