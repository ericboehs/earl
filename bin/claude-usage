#!/usr/bin/env bash
# Scrape Claude Code /usage output via tmux.
# Spawns an interactive Claude session, runs /usage, captures output, exits.
#
# Usage:
#   bin/claude-usage          # Human-readable output
#   bin/claude-usage --json   # JSON output for programmatic use
#
# Requires: tmux, claude CLI
set -euo pipefail

SESSION="claude-usage-$$"
TIMEOUT=15

cleanup() { tmux kill-session -t "$SESSION" 2>/dev/null || true; }
trap cleanup EXIT

# Start interactive Claude in detached tmux (wide to avoid text wrapping)
tmux new-session -d -s "$SESSION" -x 200 -y 50 "CLAUDECODE= claude 2>&1"

# Wait for the welcome screen
for _ in $(seq 1 "$TIMEOUT"); do
  sleep 1
  if tmux capture-pane -t "$SESSION" -p 2>/dev/null | grep -q "Welcome\|Opus\|Claude"; then
    break
  fi
done

# Send /usage â€” first Enter selects from autocomplete, second confirms
tmux send-keys -t "$SESSION" '/usage' Enter
sleep 1
tmux send-keys -t "$SESSION" Enter
sleep 3

# Capture the pane content
OUTPUT=$(tmux capture-pane -t "$SESSION" -p 2>/dev/null)

# Exit Claude cleanly
tmux send-keys -t "$SESSION" C-u
sleep 0.5
tmux send-keys -t "$SESSION" '/exit' Enter
sleep 1

# Parse the captured output
session_pct=$(echo "$OUTPUT" | grep -A1 "Current session" | grep -o '[0-9]*% used' | grep -o '[0-9]*' || echo "")
session_reset=$(echo "$OUTPUT" | grep -A2 "Current session" | grep "Resets" | sed 's/^[[:space:]]*//' | sed 's/Resets //' || echo "")

# "Current week (all models)" â€” use head -1 to pick only the first match
week_pct=$(echo "$OUTPUT" | grep -A1 "Current week (all models)" | grep -o '[0-9]*% used' | head -1 | grep -o '[0-9]*' || echo "")
week_reset=$(echo "$OUTPUT" | grep -A2 "Current week (all models)" | grep "Resets" | head -1 | sed 's/^[[:space:]]*//' | sed 's/Resets //' || echo "")

# "Current week (Sonnet only)" â€” separate field
sonnet_pct=$(echo "$OUTPUT" | grep -A1 "Current week (Sonnet only)" | grep -o '[0-9]*% used' | head -1 | grep -o '[0-9]*' || echo "")
sonnet_reset=$(echo "$OUTPUT" | grep -A2 "Current week (Sonnet only)" | grep "Resets" | head -1 | sed 's/^[[:space:]]*//' | sed 's/Resets //' || echo "")

# Fallback: if "all models" label not found, try plain "Current week" (older CLI)
if [[ -z "$week_pct" ]]; then
  week_pct=$(echo "$OUTPUT" | grep -A1 "Current week" | grep -o '[0-9]*% used' | head -1 | grep -o '[0-9]*' || echo "")
  week_reset=$(echo "$OUTPUT" | grep -A2 "Current week" | grep "Resets" | head -1 | sed 's/^[[:space:]]*//' | sed 's/Resets //' || echo "")
fi

extra_pct=$(echo "$OUTPUT" | grep -A1 "Extra usage" | grep -o '[0-9]*% used' | grep -o '[0-9]*' || echo "")
extra_detail=$(echo "$OUTPUT" | grep -A2 "Extra usage" | grep "spent" | sed 's/^[[:space:]]*//' || echo "")
extra_reset=$(echo "$extra_detail" | sed 's/.*Resets //' || echo "")
extra_spent=$(echo "$extra_detail" | grep -o '\$[0-9.]*' | head -1 || echo "")
extra_budget=$(echo "$extra_detail" | grep -o '\$[0-9.]*' | tail -1 || echo "")

if [[ "${1:-}" == "--json" ]]; then
  cat <<JSON
{
  "session": {
    "percent_used": ${session_pct:-null},
    "resets": "${session_reset}"
  },
  "week": {
    "percent_used": ${week_pct:-null},
    "resets": "${week_reset}"
  },
  "sonnet_week": {
    "percent_used": ${sonnet_pct:-null},
    "resets": "${sonnet_reset}"
  },
  "extra": {
    "percent_used": ${extra_pct:-null},
    "spent": "${extra_spent}",
    "budget": "${extra_budget}",
    "resets": "${extra_reset}"
  }
}
JSON
else
  echo "ðŸ“Š Claude Usage"
  echo ""
  if [[ -n "$session_pct" ]]; then
    echo "  Session:  ${session_pct}% used â€” resets ${session_reset}"
  fi
  if [[ -n "$week_pct" ]]; then
    echo "  Week:     ${week_pct}% used â€” resets ${week_reset}"
  fi
  if [[ -n "$sonnet_pct" ]]; then
    echo "  Sonnet:   ${sonnet_pct}% used â€” resets ${sonnet_reset}"
  fi
  if [[ -n "$extra_pct" ]]; then
    echo "  Extra:    ${extra_pct}% used (${extra_spent} / ${extra_budget}) â€” resets ${extra_reset}"
  fi
  if [[ -z "$session_pct" && -z "$week_pct" ]]; then
    echo "  âš ï¸  Could not parse usage data. Raw output:"
    echo "$OUTPUT" | sed -n '/Current session/,/Esc to cancel/p'
  fi
fi
