#!/usr/bin/env bash
set -euo pipefail

EARL_DIR="$(cd "$(dirname "$0")/.." && pwd)"
EARL_ENV="${EARL_ENV:-production}"

if [ "$EARL_ENV" = "development" ]; then
  CONFIG_DIR="$HOME/.config/earl-dev"
else
  CONFIG_DIR="$HOME/.config/earl"
fi

LAUNCH_AGENTS_DIR="$HOME/Library/LaunchAgents"
PLIST_NAME="com.boehs.earl.plist"
PROD_INSTALL_DIR="$HOME/.local/share/earl"
PROD_BIN="$HOME/bin/earl"

echo "==> Installing EARL ($EARL_ENV)..."

# 1. Create config directories
echo "  Creating $CONFIG_DIR/"
mkdir -p "$CONFIG_DIR/logs" "$CONFIG_DIR/memory" "$CONFIG_DIR/allowed_tools" "$CONFIG_DIR/mcp"

# 2. Copy default Claude project config (if not present)
CLAUDE_HOME="$CONFIG_DIR/claude-home"
if [ ! -d "$CLAUDE_HOME/.claude" ]; then
  echo "  Copying default Claude project config to $CLAUDE_HOME/"
  mkdir -p "$CLAUDE_HOME"
  cp -r "$EARL_DIR/config/earl-claude-home/.claude" "$CLAUDE_HOME/.claude"
else
  echo "  Claude project config already exists at $CLAUDE_HOME/.claude (skipping)"
fi

# 3. Create env file template (if not present)
ENV_FILE="$CONFIG_DIR/env"
if [ ! -f "$ENV_FILE" ]; then
  cat > "$ENV_FILE" <<'ENVTEMPLATE'
# EARL environment variables — fill in and restart the agent
MATTERMOST_URL=https://your-mattermost-server.example.com
MATTERMOST_BOT_TOKEN=your-bot-token
MATTERMOST_BOT_ID=your-bot-user-id
EARL_CHANNEL_ID=your-channel-id
EARL_ALLOWED_USERS=your-username
# EARL_CHANNELS=chan1:/path1,chan2:/path2
# EARL_SKIP_PERMISSIONS=true
# EARL_DEBUG=1
ENVTEMPLATE
  chmod 600 "$ENV_FILE"
  echo ""
  echo "  Created $ENV_FILE — please fill in your secrets, then re-run this script."
  echo ""
  exit 0
fi

# --- Development mode: config dirs + env template only ---
if [ "$EARL_ENV" = "development" ]; then
  echo ""
  echo "==> Dev environment ready at $CONFIG_DIR"
  echo "  Run EARL from the repo: cd $EARL_DIR && bin/earl"
  exit 0
fi

# --- Production mode: clone repo, create wrapper, install launchd ---

# 4. Clone/update production repo
if [ -d "$PROD_INSTALL_DIR/.git" ]; then
  echo "  Updating production checkout at $PROD_INSTALL_DIR..."
  git -C "$PROD_INSTALL_DIR" pull --ff-only
else
  echo "  Cloning EARL to $PROD_INSTALL_DIR..."
  mkdir -p "$(dirname "$PROD_INSTALL_DIR")"
  git clone "https://github.com/ericboehs/earl.git" "$PROD_INSTALL_DIR"
fi

echo "  Running bundle install..."
cd "$PROD_INSTALL_DIR" && bundle install --quiet

# 5. Create ~/bin/earl wrapper
mkdir -p "$(dirname "$PROD_BIN")"
cat > "$PROD_BIN" <<WRAPPER
#!/usr/bin/env bash
set -euo pipefail

# PATH setup (mise shims, homebrew, ~/bin)
export PATH="\$HOME/bin:\$HOME/.local/share/mise/shims:\$HOME/.local/bin:/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin"
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"

# Load EARL environment variables
ENV_FILE="$CONFIG_DIR/env"
if [ ! -f "\$ENV_FILE" ]; then
  echo "FATAL: Environment file not found: \$ENV_FILE" >&2
  echo "  Run 'bin/earl-install' to create it, then fill in your secrets." >&2
  exit 1
fi
set -a
# shellcheck source=/dev/null
source "\$ENV_FILE"
set +a

# Ensure Claude home dir exists
mkdir -p "$CONFIG_DIR/claude-home"

cd "$PROD_INSTALL_DIR"
exec bundle exec ruby bin/earl
WRAPPER
chmod +x "$PROD_BIN"
echo "  Created $PROD_BIN"

# 6. Generate plist pointing to ~/bin/earl
echo "  Installing launchd plist..."
mkdir -p "$LAUNCH_AGENTS_DIR"
sed -e "s|__EARL_BIN__|$PROD_BIN|g" \
    -e "s|__PROD_INSTALL_DIR__|$PROD_INSTALL_DIR|g" \
    -e "s|__HOME__|$HOME|g" \
  "$EARL_DIR/config/$PLIST_NAME" > "$LAUNCH_AGENTS_DIR/$PLIST_NAME"

# 7. Load the agent
echo "  Loading agent..."
launchctl bootout "gui/$(id -u)/com.boehs.earl" 2>/dev/null || true
if ! launchctl bootstrap "gui/$(id -u)" "$LAUNCH_AGENTS_DIR/$PLIST_NAME" 2>&1; then
  echo "" >&2
  echo "ERROR: Failed to load launchd agent." >&2
  echo "  Try: launchctl bootout gui/$(id -u)/com.boehs.earl" >&2
  echo "  Then re-run: bin/earl-install" >&2
  exit 1
fi

echo ""
echo "==> EARL installed and running!"
echo ""
echo "Useful commands:"
echo "  earl                                    # Run manually (from ~/bin)"
echo "  launchctl list | grep earl              # Check status"
echo "  tail -f $CONFIG_DIR/logs/*.log          # View logs"
echo "  launchctl kickstart -k gui/$(id -u)/com.boehs.earl  # Restart"
echo "  launchctl bootout gui/$(id -u)/com.boehs.earl       # Stop"
