#!/usr/bin/env ruby
# frozen_string_literal: true

$stdout.sync = true
$stderr.sync = true

require "bundler/setup"
require_relative "../lib/earl"

pid_file = File.join(Earl.config_root, "earl.pid")

if ARGV[0] == "restart"
  unless File.exist?(pid_file)
    warn "No PID file found at #{pid_file} — is EARL running?"
    exit 1
  end

  pid = File.read(pid_file).strip.to_i
  begin
    Process.kill("HUP", pid)
    puts "Sent SIGHUP to EARL (pid #{pid})"
  rescue Errno::ESRCH
    warn "Process #{pid} not found — removing stale PID file"
    File.delete(pid_file)
    exit 1
  end
  exit 0
end

Earl.logger.level = ENV["EARL_DEBUG"] ? Logger::DEBUG : Logger::INFO
Earl.logger.info "Starting EARL..."
File.write(pid_file, Process.pid.to_s)
runner = Earl::Runner.new
at_exit { File.delete(pid_file) if File.exist?(pid_file) }
runner.start
