#!/usr/bin/env ruby
# frozen_string_literal: true

$stdout.sync = true
$stderr.sync = true

original_verbose = $VERBOSE
$VERBOSE = nil
require "bundler/setup"
$VERBOSE = original_verbose
require_relative "../lib/earl"

pid_file = File.join(Earl.config_root, "earl.pid")

case ARGV[0]
when "restart"
  unless File.exist?(pid_file)
    warn "No PID file found at #{pid_file} — is EARL running?"
    exit 1
  end

  pid = File.read(pid_file).strip.to_i
  begin
    Process.kill("HUP", pid)
    puts "Sent SIGHUP to EARL (pid #{pid})"
  rescue Errno::ESRCH
    warn "Process #{pid} not found — removing stale PID file"
    File.delete(pid_file)
    exit 1
  end
  exit 0
when "update"
  repo_dir = File.expand_path("..", __dir__)
  Dir.chdir(repo_dir) do
    system("git", "pull", "--ff-only") || warn("git pull failed")
    system({ "RUBYOPT" => "-W0" }, "bundle", "install", "--quiet") || warn("bundle install failed")
  end
  puts "Updated. Run 'earl restart' to apply."
  exit 0
end

Earl.logger.level = ENV["EARL_DEBUG"] ? Logger::DEBUG : Logger::INFO
Earl.logger.info "Starting EARL..."
File.write(pid_file, Process.pid.to_s)
runner = Earl::Runner.new
at_exit { File.delete(pid_file) if File.exist?(pid_file) }
runner.start
